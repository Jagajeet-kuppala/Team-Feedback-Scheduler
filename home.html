<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <?!= include('homeCSS'); ?>
</head>

<body>
  <div class="header">
    <h1>Team Feedback Scheduler</h1>
  </div>
  <div class="toggleCenter">
    <label class="switch">
      <input type="checkbox" id="formSelector" onclick="toggleForm()">
      <div class="slider round">
        <span class="on">Speedback</span>
        <span class="off">Feedback</span>
      </div>
    </label>
  </div>
  <div class="center">
    <div id="feedback">
      <div class="divUsageEffect">
        <p>The feedback scheduler schedules one-on-one meetings in Google Calender for every pair in you team. <br>You can
          have multiple meetings a day (slots) or have it on consecutive working days :) <br>
          To create the calender invites follow the steps below: </p>
        <ol>
          <li>Enter the email ids of all teammates separated by comma.</li>
          <li> Select a start date from which the meetings should be scheduled.</li>
          <li>Pick the start time and end time for each meeting slot.</li>
          <li>If more slots are required for each day, click on add slot and pick the start and end time for the same.</li>
          <li> Once times have been filled in, click submit.</li>
        </ol>
        Tadaa.. Your meetings are scheduled!
        <br>
        <p>NOTE: One who schedules the meeting is the organizer of all meetings and you could add teammates outside
          ThoughtWorks too!</p>
      </div>
      <div class="center divShadowEffect">
        <form id="feedbackForm" onsubmit="handleFeedbackFormSubmit(this)">
          <div class="block form-group">
            <label for="users" class="verticalMiddle">Users Mail IDs</label>
            <input type="email" name="users" placeholder="Comma Separated" required multiple />
          </div>
          <div class="block form-group">
            <label for="startDate">Start Date</label>
            <input name="startDate" type="date" placeholder="dd/mm/yyyy" required>
          </div>
          <div class="block inline form-group" id="slots">
            <h4>Slots (Max 5 Slots): </h4>
            <input type="button" class="block action" value="Add Slot" onclick="addSlot()">
            <div id="slot" name="slot">
              <div style="float:left;">
                <label for="startTime">From</label>
                <input type="time" name="startTime" id="startTime" placeholder="HH:MM AM" required>
              </div>
              <div style="float:left;">
                <label for="endTime">To</label>
                <input type="time" name="endTime" id="endTime" placeholder="HH:MM PM" required>
              </div>
              <div style="float:left;">
                <input type="button" class="block action" value="-" onclick="removeSlot(this)">
              </div>
            </div>
          </div>
          <input type="hidden" name="userDateTime" value="">
          <input type="submit" class="block action" value="Submit" />
        </form>
        <div class="block">
          <label>
            <h3 class="inline">Schedule Status:</h3>
            <span id="feedbackScheduleStatus"></span>
          </label>
        </div>
      </div>
    </div>
    <div id="speedback">
      <div class="divUsageEffect">
        <p>The speedback form allows you to enter the names of teaammates (or nickname) and on submitting, you would get the pairs for each speedback.
          Just enter names seperated by comma and submit to get the list of all pairs :)</p>
      </div>
      <div class="center divShadowEffect">
        <form id="speedbackForm" onsubmit="handleSpeedbackFormSubmit(this)">
          <div class="block form-group">
            <label for="users" class="verticalMiddle">
              Teammates Names: <input type="text" name="users" placeholder="Comma Separated" required multiple />
            </label>
          </div>
          <input type="submit" class="block action" value="Submit" />
        </form>
        <div class="block">
          <label>
            <h3 class="inline">Schedule Status:</h3>
            <!--            <span id="speedbackScheduleStatus"></span>-->
          </label>
          <div class="block tableCenter" id="speedbackScheduleStatus">
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
<script>
  google.script.run.globalSettings();

  const todaysDate = new Date().toISOString().split('T')[0];
  document.getElementsByName("startDate")[0].setAttribute('min', todaysDate);

  document.getElementsByName("startDate")[0].addEventListener("change", function () {
    const startDate = document.getElementsByName("startDate")[0].value;
    if (startDate === todaysDate) {
      const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
      for (let slotItr = 0; slotItr < document.getElementsByName("startDate").length; slotItr++) {
        document.getElementsByName("startTime")[slotItr].setAttribute('min', currentTime);
      }
    } else {
      for (let slotItr = 0; slotItr < document.getElementsByName("startDate").length; slotItr++) {
        document.getElementsByName("startTime")[slotItr].removeAttribute('min');
      }
    }
  });

  document.getElementsByName("startTime")[0].addEventListener("change", function () {
      const startTime = document.getElementsByName("startTime")[0].value;
      document.getElementsByName("endTime")[0].setAttribute('min', startTime);
  });
  // Prevent forms from submitting.
  function preventFormSubmit() {
    const forms = document.querySelectorAll('form');
    for (let i = 0; i < forms.length; i++) {
      forms[i].addEventListener('submit', function (event) {
        event.preventDefault();
      });
    }
  }
  window.addEventListener('load', preventFormSubmit);

  function handleFeedbackFormSubmit(formObject) {
    const date = new Date().toString();
    document.getElementsByName("userDateTime")[0].setAttribute('value', date);
    const div = document.getElementById('feedbackScheduleStatus');
    div.innerHTML = "Scheduling...";
    google.script.run.withSuccessHandler(updateFeedbackSchedulerStatus).processFeedbackForm(formObject);
  }

  function handleSpeedbackFormSubmit(formObject) {
    const div = document.getElementById('speedbackScheduleStatus');
    div.innerHTML = "Scheduling...";
    google.script.run.withSuccessHandler(updateSpeedbackSchedulerStatus).processSpeedbackForm(formObject);
  }

  function updateFeedbackSchedulerStatus(status) {
    const div = document.getElementById('feedbackScheduleStatus');
    div.innerHTML = status;
  }

  function updateSpeedbackSchedulerStatus(status) {
    const div = document.getElementById('speedbackScheduleStatus');
    div.innerHTML = status;
  }

  function addSlot() {
    const slots = document.getElementById("slots");
    const slotDiv = document.createElement('div');

    const allSlots = document.getElementsByName("slot");
    if(allSlots.length < 5) {
        slotDiv.innerHTML = document.getElementById("slot").innerHTML;
        slotDiv.id = "slot";
        slotDiv.setAttribute("name", "slot");
        slots.appendChild(slotDiv);
        const startTimeEle = slotDiv.querySelector('input#startTime');
        startTimeEle.addEventListener("change", function () {
            const startTime = startTimeEle.value;
            slotDiv.querySelector('input#endTime').setAttribute('min', startTime);
        });
    }
  }

  function removeSlot (input) {
      const allSlots = document.getElementsByName("slot");
      if(allSlots.length > 1) {
        input.parentNode.parentNode.remove();
      }
  }

  function toggleForm() {
    const feedbackDiv = document.getElementById("feedback");
    const speedbackDiv = document.getElementById("speedback");
    const toggleButton = document.getElementById("formSelector");

    if (toggleButton.checked) {
      feedbackDiv.style.display = "none";
      speedbackDiv.style.display = "block";
    }
    else {
      feedbackDiv.style.display = "block";
      speedbackDiv.style.display = "none";
    }
  }
</script>

</html>
